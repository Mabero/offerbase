<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Widget Frame</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            background: transparent;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }
        
        #chat-widget-container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        .error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #666;
            font-size: 14px;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div id="chat-widget-container">
        <div class="loading-spinner"></div>
    </div>
    
    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const siteId = urlParams.get('siteId');
        const apiUrl = urlParams.get('apiUrl');
        const settingsParam = urlParams.get('settings');
        const embedded = urlParams.get('embedded') === 'true';
        
        // Decode settings
        let chatSettings = {
            chat_name: 'Affi',
            chat_color: '#000000',
            chat_icon_url: '',
            chat_name_color: '#FFFFFF',
            chat_bubble_icon_color: '#FFFFFF',
            input_placeholder: 'Type your message...',
            font_size: '14px',
            intro_message: 'Hello! How can I help you today?'
        };
        
        if (settingsParam) {
            try {
                chatSettings = JSON.parse(decodeURIComponent(settingsParam));
            } catch (e) {
                console.warn('Failed to parse settings, using defaults', e);
            }
        }
        
        // Configuration
        const config = {
            siteId: siteId || 'demo-site',
            apiUrl: decodeURIComponent(apiUrl || window.location.origin),
            settings: chatSettings,
            embedded: embedded
        };
        
        console.log('Widget frame config:', config);
        
        // Initialize widget using self-contained implementation
        async function initializeWidget() {
            try {
                // Remove loading spinner
                document.querySelector('.loading-spinner').remove();
                
                // Create the self-contained chat widget
                createChatWidget();
                
                console.log('Self-contained widget initialized');
                
            } catch (error) {
                console.error('Failed to initialize widget:', error);
                
                // Show error message
                document.querySelector('.loading-spinner').remove();
                document.getElementById('chat-widget-container').innerHTML = 
                    '<div class="error-message">Failed to load chat widget. Please refresh the page.</div>';
            }
        }
        
        // Self-contained chat widget implementation
        function createChatWidget() {
            const container = document.getElementById('chat-widget-container');
            
            // Widget HTML structure
            container.innerHTML = `
                <div class="chat-container">
                    <div class="chat-header">
                        <div class="chat-avatar">
                            ${config.settings.chat_icon_url ? 
                                `<img src="${config.settings.chat_icon_url}" alt="${config.settings.chat_name}" />` : 
                                config.settings.chat_name.charAt(0).toUpperCase()
                            }
                        </div>
                        <div class="chat-name">${config.settings.chat_name}</div>
                    </div>
                    
                    <div class="chat-messages" id="chat-messages">
                        <div class="message-row">
                            <div class="message-avatar">
                                ${config.settings.chat_icon_url ? 
                                    `<img src="${config.settings.chat_icon_url}" alt="${config.settings.chat_name}" />` : 
                                    config.settings.chat_name.charAt(0).toUpperCase()
                                }
                            </div>
                            <div class="message-bubble bot-message">
                                <p>${config.settings.intro_message || 'Hello! How can I help you today?'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chat-input-container">
                        <div class="input-wrapper">
                            <input type="text" id="chat-input" placeholder="${config.settings.input_placeholder}" />
                            <button id="send-button" type="button">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="m22 2-7 20-4-9-9-4 20-7z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add CSS styles
            const style = document.createElement('style');
            style.textContent = `
                .chat-container {
                    width: 100%;
                    height: 100%;
                    display: flex;
                    flex-direction: column;
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Inter", sans-serif;
                    background: white;
                    overflow: hidden;
                }
                
                .chat-header {
                    display: flex;
                    align-items: center;
                    padding: 16px;
                    background-color: ${config.settings.chat_color};
                    color: ${config.settings.chat_name_color};
                    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                }
                
                .chat-avatar, .message-avatar {
                    width: 32px;
                    height: 32px;
                    border-radius: 50%;
                    background-color: #f3f4f6;
                    color: #6b7280;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: 600;
                    font-size: 14px;
                    overflow: hidden;
                    margin-right: 12px;
                }
                
                .chat-avatar img, .message-avatar img {
                    width: 100%;
                    height: 100%;
                    object-fit: cover;
                }
                
                .chat-name {
                    font-weight: 600;
                    font-size: ${config.settings.font_size};
                }
                
                .chat-messages {
                    flex: 1;
                    overflow-y: auto;
                    padding: 16px;
                    background: #f9fafb;
                }
                
                .message-row {
                    display: flex;
                    align-items: flex-start;
                    margin-bottom: 12px;
                }
                
                .message-row.user {
                    justify-content: flex-end;
                }
                
                .message-row.user .message-avatar {
                    order: 2;
                    margin-left: 12px;
                    margin-right: 0;
                }
                
                .message-bubble {
                    background: rgba(255, 255, 255, 0.95);
                    backdrop-filter: blur(4px);
                    border: 1px solid rgba(255, 255, 255, 0.3);
                    border-radius: 16px;
                    padding: 12px 16px;
                    max-width: 80%;
                    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                    font-size: ${config.settings.font_size};
                }
                
                .message-bubble p {
                    margin: 0;
                    color: #1f2937;
                    line-height: 1.5;
                }
                
                .typing-indicator {
                    display: flex;
                    align-items: center;
                    gap: 4px;
                    height: 20px;
                }
                
                .typing-dot {
                    width: 8px;
                    height: 8px;
                    border-radius: 50%;
                    background-color: #6b7280;
                    opacity: 0.4;
                    animation: bounce 1.4s infinite ease-in-out;
                }
                
                .typing-dot:nth-child(1) { animation-delay: 0s; }
                .typing-dot:nth-child(2) { animation-delay: 0.2s; }
                .typing-dot:nth-child(3) { animation-delay: 0.4s; }
                
                .typing-cursor {
                    animation: blink 1s infinite;
                }
                
                .chat-input-container {
                    padding: 16px;
                    border-top: 1px solid #e5e7eb;
                    background: #f9fafb;
                }
                
                .input-wrapper {
                    position: relative;
                    display: flex;
                    align-items: center;
                }
                
                #chat-input {
                    width: 100%;
                    padding: 12px 48px 12px 16px;
                    border: 1px solid #d1d5db;
                    border-radius: 24px;
                    outline: none;
                    font-size: ${config.settings.font_size};
                    font-family: inherit;
                    background: white;
                }
                
                #send-button {
                    position: absolute;
                    right: 8px;
                    top: 50%;
                    transform: translateY(-50%);
                    width: 32px;
                    height: 32px;
                    border-radius: 50%;
                    border: none;
                    background-color: ${config.settings.chat_color};
                    color: white;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                    transition: all 0.2s ease;
                }
                
                #send-button:disabled {
                    opacity: 0.5;
                    cursor: not-allowed;
                }
                
                @keyframes bounce {
                    0%, 60%, 100% {
                        transform: scale(0.8);
                        opacity: 0.4;
                    }
                    30% {
                        transform: scale(1.2);
                        opacity: 1;
                    }
                }
                
                @keyframes blink {
                    0%, 50% { opacity: 1; }
                    51%, 100% { opacity: 0; }
                }
            `;
            document.head.appendChild(style);
            
            // Initialize chat functionality
            initializeChatFunctionality();
        }
        
        function initializeChatFunctionality() {
            const input = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');
            const messagesContainer = document.getElementById('chat-messages');
            let isLoading = false;
            
            // Send message function
            const sendMessage = async () => {
                const message = input.value.trim();
                if (!message || isLoading) return;
                
                input.value = '';
                isLoading = true;
                sendButton.disabled = true;
                
                // Add user message
                addMessage(message, true);
                
                // Show typing indicator
                const typingId = showTypingIndicator();
                
                try {
                    // Send analytics
                    sendAnalytics('message_sent', { message_length: message.length });
                    
                    const response = await fetch(`${config.apiUrl}/api/chat`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-site-id': config.siteId
                        },
                        body: JSON.stringify({
                            message: message,
                            siteId: config.siteId,
                            conversationHistory: [],
                            sessionId: 'session_' + Date.now()
                        })
                    });
                    
                    if (!response.ok) throw new Error('Network response was not ok');
                    
                    const data = await response.json();
                    
                    // Remove typing indicator
                    removeTypingIndicator(typingId);
                    
                    // Add bot response with typewriter effect
                    if (data.type === 'message' && typeof data.message === 'string') {
                        addTypingMessage(data.message);
                    } else {
                        addMessage(data.message || 'Sorry, I encountered an error.', false);
                    }
                    
                } catch (error) {
                    console.error('Error:', error);
                    removeTypingIndicator(typingId);
                    addMessage('Sorry, I encountered an error. Please try again.', false);
                }
                
                isLoading = false;
                sendButton.disabled = false;
            };
            
            // Event listeners
            sendButton.addEventListener('click', sendMessage);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !isLoading) {
                    sendMessage();
                }
            });
            
            // Message functions
            function addMessage(text, isUser) {
                const messageRow = document.createElement('div');
                messageRow.className = `message-row ${isUser ? 'user' : ''}`;
                
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.innerHTML = isUser ? 'U' : 
                    (config.settings.chat_icon_url ? 
                        `<img src="${config.settings.chat_icon_url}" alt="${config.settings.chat_name}" />` : 
                        config.settings.chat_name.charAt(0).toUpperCase()
                    );
                
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                const p = document.createElement('p');
                p.textContent = text;
                bubble.appendChild(p);
                
                messageRow.appendChild(avatar);
                messageRow.appendChild(bubble);
                messagesContainer.appendChild(messageRow);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            function showTypingIndicator() {
                const messageRow = document.createElement('div');
                messageRow.className = 'message-row';
                const id = 'typing-' + Date.now();
                messageRow.id = id;
                
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.innerHTML = config.settings.chat_icon_url ? 
                    `<img src="${config.settings.chat_icon_url}" alt="${config.settings.chat_name}" />` : 
                    config.settings.chat_name.charAt(0).toUpperCase();
                
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                bubble.innerHTML = `
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                `;
                
                messageRow.appendChild(avatar);
                messageRow.appendChild(bubble);
                messagesContainer.appendChild(messageRow);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                return id;
            }
            
            function removeTypingIndicator(id) {
                const element = document.getElementById(id);
                if (element) element.remove();
            }
            
            function addTypingMessage(text) {
                const messageRow = document.createElement('div');
                messageRow.className = 'message-row';
                
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.innerHTML = config.settings.chat_icon_url ? 
                    `<img src="${config.settings.chat_icon_url}" alt="${config.settings.chat_name}" />` : 
                    config.settings.chat_name.charAt(0).toUpperCase();
                
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                const p = document.createElement('p');
                bubble.appendChild(p);
                
                messageRow.appendChild(avatar);
                messageRow.appendChild(bubble);
                messagesContainer.appendChild(messageRow);
                
                // Typewriter effect
                let index = 0;
                let displayText = '';
                const typeCharacter = () => {
                    if (index < text.length) {
                        displayText += text[index];
                        p.innerHTML = displayText + '<span class="typing-cursor">|</span>';
                        index++;
                        setTimeout(typeCharacter, 15);
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    } else {
                        p.textContent = text; // Remove cursor
                    }
                };
                
                setTimeout(typeCharacter, 25);
            }
            
            function sendAnalytics(eventType, details) {
                try {
                    fetch(`${config.apiUrl}/api/analytics`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            event_type: eventType,
                            site_id: config.siteId,
                            user_id: null,
                            details: details
                        })
                    }).catch(() => {});
                } catch (error) {
                    // Silently handle analytics errors
                }
            }
        }
        
        // Start initialization
        initializeWidget();
        
        // Listen for messages from parent window
        window.addEventListener('message', (event) => {
            if (event.data.type === 'CHAT_SETTINGS_UPDATE') {
                console.log('Received settings update:', event.data.settings);
                // TODO: Update widget settings
            }
        });
        
        // Notify parent that widget is ready
        window.addEventListener('load', () => {
            if (window.parent !== window) {
                window.parent.postMessage({
                    type: 'WIDGET_READY',
                    siteId: config.siteId
                }, '*');
            }
        });
    </script>
</body>
</html>